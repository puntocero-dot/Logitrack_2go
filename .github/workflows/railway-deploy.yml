# Railway Auto-Deploy Workflow
# Despliega autom√°ticamente todos los servicios cuando hay push a master

name: Deploy to Railway

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Services to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üöÄ Deploying to Railway..."
          echo "Token present: ${{ secrets.RAILWAY_TOKEN != '' }}"
          
          # Verificar que el token existe
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "‚ùå ERROR: RAILWAY_TOKEN not found in secrets!"
            echo ""
            echo "Para configurar:"
            echo "1. Ve a Railway ‚Üí Account Settings ‚Üí Tokens"
            echo "2. Crea un nuevo token"
            echo "3. Ve a GitHub ‚Üí Settings ‚Üí Secrets ‚Üí Actions"
            echo "4. Crea un secret llamado RAILWAY_TOKEN con el valor del token"
            exit 1
          fi
          
          # Listar proyectos disponibles para verificar conexi√≥n
          echo "üìã Verificando conexi√≥n con Railway..."
          railway whoami || echo "No se pudo verificar usuario"
          
          # Intentar deploy de cada servicio
          echo ""
          echo "üåê Deploying web-app..."
          cd web-app && railway up -d 2>&1 || echo "‚ö†Ô∏è web-app: requiere configuraci√≥n manual en Railway"
          cd ..
          
          echo ""
          echo "üîå Deploying api-gateway..."
          cd api-gateway && railway up -d 2>&1 || echo "‚ö†Ô∏è api-gateway: requiere configuraci√≥n manual"
          cd ..
          
          echo ""
          echo "üë§ Deploying user-service..."
          cd user-service && railway up -d 2>&1 || echo "‚ö†Ô∏è user-service: requiere configuraci√≥n manual"
          cd ..
          
          echo ""
          echo "üì¶ Deploying order-service..."
          cd order-service && railway up -d 2>&1 || echo "‚ö†Ô∏è order-service: requiere configuraci√≥n manual"
          cd ..
          
          echo ""
          echo "ü§ñ Deploying ai-service..."
          cd ai-service && railway up -d 2>&1 || echo "‚ö†Ô∏è ai-service: requiere configuraci√≥n manual"
          cd ..
          
          echo ""
          echo "üìç Deploying geolocation-service..."
          cd geolocation-service && railway up -d 2>&1 || echo "‚ö†Ô∏è geolocation-service: requiere configuraci√≥n manual"
          cd ..
          
          echo ""
          echo "üëÅÔ∏è Deploying client-view..."
          cd client-view && railway up -d 2>&1 || echo "‚ö†Ô∏è client-view: requiere configuraci√≥n manual"
          cd ..
          
          echo ""
          echo "‚úÖ Deploy script completed!"
          echo ""
          echo "üìù Si los servicios no se desplegaron:"
          echo "   1. Ve a Railway Dashboard"
          echo "   2. Conecta cada servicio a GitHub directamente"
          echo "   3. Especifica la carpeta ra√≠z de cada servicio"
